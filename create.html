<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fidget Creator</title>
  <style>
    :root {
      --primary: #ff5588;
      --primary-dark: #e04178;
      --bg: #eef2f3;
      --text: #222;
      --error: #cc4444;
      --radius: 12px;
      --transition: 0.2s ease;
    }
    * { box-sizing: border-box; margin: 0; padding: 0 }
    body {
      background: linear-gradient(135deg, #fdfbfb, var(--bg));
      color: var(--text);
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: var(--primary);
      padding: 1rem;
      color: white;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
    }
    main {
      flex: 1;
      max-width: 720px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .field-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    label {
      font-weight: 600;
      margin-bottom: 0.3rem;
      display: block;
    }
    input, select, textarea, button {
      width: 100%;
      font: inherit;
      padding: 0.6rem;
      border: 1px solid #ccc;
      border-radius: var(--radius);
      transition: border var(--transition), background var(--transition);
      margin-bottom: 1rem;
    }
    textarea { resize: vertical; }
    button {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      border-radius: var(--radius);
    }
    button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: background-color var(--transition);
      border-radius: var(--radius);
    }
    .slider::before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: transform var(--transition);
      border-radius: 50%;
    }
    .switch input:checked + .slider {
      background-color: var(--primary);
    }
    .switch input:checked + .slider::before {
      transform: translateX(24px);
    }
    .hidden { display: none }
    .preview, .errors {
      white-space: pre-wrap;
      background: #fff;
      padding: 1rem;
      border-radius: var(--radius);
      border: 1px solid #ddd;
      font-family: monospace;
      font-size: 0.9rem;
      margin-top: 1rem;
    }
    .errors { color: var(--error) }
    #spinnerPreviewContainer {
      text-align: center;
      margin-top: 1rem;
      transition: opacity var(--transition);
    }
    #spinnerPreview { width:128px; height:128px; }
    @keyframes spin {
      from { transform: rotate(0deg) }
      to { transform: rotate(360deg) }
    }
  </style>
</head>
<body>
  <header>‚ú® Fidget Creator</header>
  <main>
    <p>Create your own <code>.fidget</code> file‚Äîlive preview and fun errors included!</p>

    <!-- Advanced Mode Row -->
    <div class="field-row">
      <strong>Advanced Mode</strong>
      <label class="switch">
        <input type="checkbox" id="advancedToggle">
        <span class="slider"></span>
      </label>
    </div>

    <!-- Advanced Settings Panel -->
    <div id="advancedSettings" class="hidden" style="padding:0.5rem 1rem; border:1px dashed #ccc; border-radius:var(--radius); margin-bottom:1rem;">
      <label><input type="checkbox" id="autoResize" checked> Auto-resize images to 256√ó256</label>
      <label><input type="checkbox" id="convertPNG" checked> Convert images to PNG</label>
      <label>Schema Version</label>
      <input type="text" id="schemaVersion" placeholder="e.g. 1.0" value="1.0">
    </div>

    <label>Name</label>
    <input id="name" placeholder="e.g. Bubble Pop">

    <label>Creator</label>
    <input id="creator" placeholder="Your name">

    <label>Type</label>
    <select id="type" onchange="handleTypeChange()">
      <option value="">‚Äî Select ‚Äî</option>
      <option value="toggle">Toggle</option>
      <option value="spinner">Spinner</option>
    </select>

    <label>imageA upload</label>
    <input type="file" id="uploadA" accept="image/png,image/jpeg,image/webp,image/svg+xml,image/gif">
    <textarea id="imageA" placeholder="Data URL for imageA..."></textarea>

    <div id="toggleSection" class="hidden">
      <label>imageB upload</label>
      <input type="file" id="uploadB" accept="image/png,image/jpeg,image/webp,image/svg+xml,image/gif">
      <textarea id="imageB" placeholder="Data URL for imageB (optional)"></textarea>

      <label>Sound upload</label>
      <input type="file" id="uploadSound" accept="audio/mp3,audio/ogg">
      <textarea id="sound" placeholder="Data URL for sound (optional)"></textarea>
    </div>

    <div id="spinnerSection" class="hidden">
      <label>Angular Velocity (rad/s)</label>
      <input type="number" id="velocity" placeholder="Default: 40" step="0.1">
    </div>

    <button onclick="downloadFidget()">üì¶ Download .fidget</button>

    <div class="errors hidden" id="errorOutput"></div>
    <div class="preview" id="previewOutput">{}</div>

    <div id="spinnerPreviewContainer" class="hidden">
      <img id="spinnerPreview">
    </div>
  </main>

  <footer style="text-align:center; padding:1rem; color:#888;">
    ¬© 2025 Fidgety Web Portal ‚Äî <a href="https://fidgetyfidgets.github.io" target="_blank">fidgetyfidgets.github.io</a>
  </footer>

  <script>
    const refs = {
      advToggle: document.getElementById('advancedToggle'),
      advSettings: document.getElementById('advancedSettings'),
      autoResize: document.getElementById('autoResize'),
      convertPNG: document.getElementById('convertPNG'),
      schemaInput: document.getElementById('schemaVersion'),
      name: document.getElementById('name'),
      creator: document.getElementById('creator'),
      type: document.getElementById('type'),
      imageA: document.getElementById('imageA'),
      imageB: document.getElementById('imageB'),
      sound: document.getElementById('sound'),
      velocity: document.getElementById('velocity'),
      preview: document.getElementById('previewOutput'),
      errors: document.getElementById('errorOutput'),
      spinnerContainer: document.getElementById('spinnerPreviewContainer'),
      spinnerImg: document.getElementById('spinnerPreview')
    };

    // Show/hide advanced settings
    refs.advToggle.addEventListener('change', () => {
      refs.advSettings.classList.toggle('hidden', !refs.advToggle.checked);
      updatePreview();
    });

    function displayError(msg) {
      refs.errors.textContent = msg;
      refs.errors.classList.remove('hidden');
    }
    function clearError() {
      refs.errors.textContent = '';
      refs.errors.classList.add('hidden');
    }

    function handleTypeChange() {
      const t = refs.type.value;
      document.getElementById('toggleSection').classList.toggle('hidden', t !== 'toggle');
      document.getElementById('spinnerSection').classList.toggle('hidden', t !== 'spinner');
      updatePreview();
    }

    function resizeAndEncode(file, cb) {
      const reader = new FileReader();
      reader.onload = () => {
        // default to resize+convert when advanced OFF,
        // when advanced ON respect the toggles
        const doResize  = !refs.advToggle.checked || refs.autoResize.checked;
        const doConvert = !refs.advToggle.checked || refs.convertPNG.checked;
        if (!doResize && !doConvert) return cb(reader.result);

        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const w = doResize ? 256 : img.width;
          const h = doResize ? 256 : img.height;
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          const outputType = doConvert ? 'image/png' : file.type;
          cb(canvas.toDataURL(outputType));
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    // File inputs
    ['uploadA','uploadB'].forEach(id => {
      document.getElementById(id).onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        resizeAndEncode(file, data => {
          document.getElementById(id==='uploadA'?'imageA':'imageB').value = data;
          updatePreview();
        });
      };
    });
    document.getElementById('uploadSound').onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        refs.sound.value = reader.result;
        updatePreview();
      };
      reader.readAsDataURL(file);
    };

    // Live preview triggers
    ['name','creator','imageA','imageB','sound','velocity','type','autoResize','convertPNG','schemaVersion']
      .forEach(id => document.getElementById(id).addEventListener('input', updatePreview));

    function updatePreview() {
      clearError();
      const t = refs.type.value;
      if (!t) {
        displayError('‚ö†Ô∏è Please select a fidget type!');
        refs.preview.textContent = '{}';
        refs.spinnerContainer.classList.add('hidden');
        return;
      }
      if (!refs.imageA.value.trim()) {
        displayError('‚ùå imageA is required! Upload or paste a Data URL.');
        refs.preview.textContent = '{}';
        refs.spinnerContainer.classList.add('hidden');
        return;
      }

      const schemaVer = refs.advToggle.checked && refs.schemaInput.value.trim()
        ? refs.schemaInput.value.trim()
        : '1.0';

      const obj = {
        schemaVersion: schemaVer,
        type: t,
        name: refs.name.value.trim() || 'Untitled Fidget',
        author: refs.creator.value.trim() || undefined,
        imageA: refs.imageA.value.trim()
      };
      if (t === 'toggle') {
        if (refs.imageB.value.trim()) obj.imageB = refs.imageB.value.trim();
        if (refs.sound.value.trim()) obj.sound = refs.sound.value.trim();
      }
      if (t === 'spinner') {
        let v = parseFloat(refs.velocity.value);
        if (isNaN(v) || v <= 0) v = 40;
        obj.velocity = v;
      }
      refs.preview.textContent = JSON.stringify(obj, null, 2);

      if (t === 'spinner') {
        refs.spinnerImg.src = obj.imageA;
        const duration = (2 * Math.PI) / obj.velocity;
        refs.spinnerImg.style.animation = `spin ${duration}s linear infinite`;
        refs.spinnerContainer.classList.remove('hidden');
      } else {
        refs.spinnerContainer.classList.add('hidden');
      }
    }

    function downloadFidget() {
      updatePreview();
      if (refs.errors.textContent) return;
      const blob = new Blob([refs.preview.textContent], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const name = JSON.parse(refs.preview.textContent).name || 'fidget';
      a.download = name.replace(/\s+/g, '_') + '.fidget';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Initialize
    updatePreview();
  </script>
</body>
</html>